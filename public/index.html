<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Qitmeer Miner</title>
    <script src="js/jquery.js"></script>
</head>
<body>
    <h1>Qitmeer Miner Stats Platform</h1>

    <div>
        <h3>Available GPU Devices(the selected will be used to mining)</h3>
        <hr />
        <div id="devices" style="margin-bottom: 10px"></div>
        <input type="button" value="modify" style="width: 150px;padding-bottom: 5px;font-size: 28px;font-weight: bolder;" onclick="changeDeviceStatus(this.id)">
        <hr />
    </div>
    <h3>Config Params</h3>
    <hr />
    <div>
        <h4>Solo Config</h4>
        miner address：<input type="text" value="" id="miner_addr">
        qitmeer rpc server：<input type="text" value="" id="rpc_server">
        rpc username：<input type="text" value="" id="rpc_username">
        rpc password：<input type="text" value="" id="rpc_password">
    </div>

    <div>
        <h4>Pool Config</h4>
        stratum address：<input type="text" value="" id="stratum_addr">
        stratum user：<input type="text" value="" id="stratum_user">
        stratum pass：<input type="text" value="" id="stratum_pass">
    </div>
    <input type="button" value="restart mining" style="width: 250px;padding-bottom: 5px;font-size: 28px;font-weight: bolder;" onclick="submitData()">
    <hr />
    <div>
        <h3>Running Stats</h3>
        <div id="stats"></div>
    </div>
<script>
    let getMinerData = function () {
        $.ajax({
            url:'/miner_data',
            data:{},
            type:'get',
            dataType:'json',
        }).done(function (d) {
            let deviceHtml = '';
            $('#miner_addr').val(d.config.SoloConfig.MinerAddr);
            $('#rpc_server').val(d.config.SoloConfig.RPCServer);
            $('#rpc_username').val(d.config.SoloConfig.RPCUser);
            $('#rpc_password').val(d.config.SoloConfig.RPCPassword);
            $('#stratum_addr').val(d.config.PoolConfig.Pool);
            $('#stratum_user').val(d.config.PoolConfig.PoolUser);
            $('#stratum_pass').val(d.config.PoolConfig.PoolPassword);
            $.each(d.devices,function(k,v){
                let checked = '';
                if (v.isValid){
                    checked = 'checked="checked"';
                }
                deviceHtml += '<div><input type="checkbox" id=d_'+v.id+' '+checked+' /> #'+ v.id + '[' + v.name + '] ' +
                    'Intensity:<input type="text" value="'+v.global_size+'" id=gs_'+v.id+' /> LocalSize:<input type="text" value="'+v.local_size+'" id=ws_'+v.id+' /></div>';
            });
            $('#devices').html(deviceHtml);
            let statsHtml = "Accept Count:"+d.config.OptionConfig.Accept + " Reject Count:"+d.config.OptionConfig.Reject+" Stale Count:" + d.config.OptionConfig.Stale;
            $('#stats').html(statsHtml);
        })
    };
    let changeDeviceStatus = function (id) {
        let ids = '';
        let inters = "";
        let lsizes = "";
        $('#devices input:checkbox').each(function() {
            if ($(this).is(':checked') === true) {
                let id = $(this).attr('id').replace("d_","");
                let intersize = $('#gs_'+id).val();
                let lsize = $('#ws_'+id).val();
                console.log(id);
                ids += id+',';
                inters += intersize+',';
                lsizes += lsize+',';
            }
        });
        if (ids.length>0){
            ids = ids.substr(ids,ids.length-1);
            inters = inters.substr(inters,inters.length-1);
            lsizes = lsizes.substr(lsizes,lsizes.length-1);
        }
        $.ajax({
            url:'/set_devices',
            data:{
                ids:ids,
                inters:inters,
                lsizes:lsizes,
            },
            type:'post',
            dataType:'json',
        }).done(function (d) {
            alert("set success");
        })
    };
    let submitData = function () {
        $.ajax({
            url:'/set_params',
            data:{
                miner_addr:$('#miner_addr').val(),
                rpc_server:$('#rpc_server').val(),
                rpc_username:$('#rpc_username').val(),
                rpc_password:$('#rpc_password').val(),
                stratum_addr:$('#stratum_addr').val(),
                stratum_user:$('#stratum_user').val(),
                stratum_pass:$('#stratum_pass').val()
            },
            type:'post',
            dataType:'json',
        }).done(function (d) {
            alert("set success");
        })
    };
    getMinerData();
</script>
</body>
</html>